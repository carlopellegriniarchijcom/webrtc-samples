<!DOCTYPE html>
<html>
<head>
<title>Apprtc Camera Constraints Test</title>
<style>
video {
  border:5px solid black;
  width:480px;
  height:360px;
}
pre{border:1px solid black;}
</style>
</head>
<body>
<video id="vid1" autoplay></video>
<br>
<span style="Margin-left:0px">Ratio</span>
<span style="Margin-left:25px">Size</span>
<span style="Margin-left:95px">FPS</span>
<br>
<select id="Ratio">
  <option value="default">Default</option>
  <option value="standard">4:3</option>
  <option value="wide">16:9</option>
</select>
<select id="Size">
  <option value="default">Default</option>
  <option value="vga">640x480 VGA</option>
  <option value="qvga">320x240 QVGA</option>
  <option value="hd">960x720 HD</option>
  <option value="other">Other</option>
</select>
<input type="range" id="Rate" min="0" max="60" value="30"
  onchange="showValue(this.id, this.value)">
<span id="RateDisplay">30</span>
<button id="btn1" onclick="start()">Start</button>
<button id="btn2" onclick="reset()">Reset</button>
<pre id="debug"></pre>
<script>
var localstream;
btn1.disabled = false;

function trace(txt) {
  // This function is used for logging.
  var elem = document.getElementById("debug");
  elem.innerHTML += txt + "<br>";
}

function reset() {
  // Reload the test page to test with the options selected.
  self.location.reload();
}

function start() {
  btn1.disabled = true;
  var index;
  index = document.getElementById("Ratio").selectedIndex;
  var ratio = document.getElementById("Ratio").options[index].value;

  index = document.getElementById("Size").selectedIndex;
  var size = document.getElementById("Size").options[index].value;

  var fps = document.getElementById("Rate").value;

  trace("Selection: " + ratio + " " + size + " " + fps);
  var constraints = makeConstraints(ratio, size, parseInt(fps));
  getUserMedia(constraints);
}  

function makeConstraints(video_ratio, video_size, video_fps) {
  constraints = { 'mandatory': {}, 'optional': []};
  if (video_ratio == 'wide') {
    constraints.mandatory.maxAspectRatio = 1.778;
    constraints.mandatory.minAspectRatio = 1.777;
  }

  if (video_size == 'qvga') {
    constraints.mandatory.maxWidth = 320;
    constraints.mandatory.maxHeight = 240;
  } else if (video_size == 'hd') {
    constraints.mandatory.minWidth = 960;
    constraints.mandatory.minHeight = 720;
  } else {
    constraints.optional.push({ 'maxWidth': 640});
    constraints.optional.push({ 'maxHeight': 480});
  }

  if (video_fps < 30)
    constraints.mandatory.maxFrameRate = video_fps;
  else
    constraints.optional.push({ 'minFrameRate': video_fps});

  return constraints;
}

function getUserMedia(constraints) {
  trace("Please check the mediaConstraints is right or not:");
  trace("\"" + JSON.stringify(constraints) + "\"");
  navigator.webkitGetUserMedia({'audio':true, 'video':constraints},
                               onUserMediaSuccess, onUserMediaError);
}  

function onUserMediaSuccess(stream) {
  trace("Please check if you get the expected video.");
  vid1.src = webkitURL.createObjectURL(stream);
  localstream = stream;
  trace("Then you can reset to change the test options and start again.");
}

function onUserMediaError(error) {
  trace("Failed to get access to local media. Error code was " + error.code);
  alert("Failed to get access to local media. Error code was " + error.code + ".");
}

function showValue(name, value) {
  document.getElementById(name + 'Display').innerHTML = value;
}
</script>
</body>
</html>


